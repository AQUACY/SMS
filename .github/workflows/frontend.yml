name: Deploy Frontend to Shared Hosting

# This workflow deploys the Quasar/Vue frontend to shared hosting via FTPS
# It builds the frontend with the production API URL and deploys to /public_html
# No SSH access required - uses FTPS (FTP over SSL/TLS) for secure transfer

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend.yml'
  workflow_dispatch: # Allow manual trigger from GitHub Actions UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      # Step 3: Install dependencies
      - name: Install npm dependencies
        run: |
          cd frontend
          npm ci
      
      # Step 4: Verify API URL is set
      - name: Verify API URL environment variable
        run: |
          echo "API_URL: ${{ secrets.FRONTEND_API_URL || 'https://sms.kdgsolution.com/api' }}"
          echo "VITE_API_URL: ${{ secrets.FRONTEND_API_URL || 'https://sms.kdgsolution.com/api' }}"
      
      # Step 5: Build frontend with production API URL
      # The API_URL is injected via rawDefine and extendViteConf in quasar.config.js
      - name: Build frontend
        run: |
          cd frontend
          echo "Building with API_URL: $API_URL"
          echo "Building with VITE_API_URL: $VITE_API_URL"
          npm run build
        env:
          NODE_ENV: production
          QUASAR_MODE: spa
          API_URL: ${{ secrets.FRONTEND_API_URL || 'https://sms.kdgsolution.com/api' }}
          # Also set as VITE_API_URL as fallback
          VITE_API_URL: ${{ secrets.FRONTEND_API_URL || 'https://sms.kdgsolution.com/api' }}
      
      # Step 6: Verify API URL in built files
      - name: Verify API URL in build
        run: |
          cd frontend/dist/spa
          echo "Checking for API URL in built files..."
          if grep -r "localhost:8000" . 2>/dev/null; then
            echo "‚ö†Ô∏è  WARNING: Found localhost:8000 in built files!"
            exit 1
          else
            echo "‚úÖ No localhost found - API URL should be correctly replaced"
          fi
          if grep -r "sms.kdgsolution.com" . 2>/dev/null || grep -r "api.yourschool.com" . 2>/dev/null; then
            echo "‚úÖ Found production API URL in built files"
          fi
        continue-on-error: true
      
      # Step 7: Deploy built files to /public_html
      # The Quasar build outputs to dist/spa/ directory
      - name: Deploy frontend to /public_html
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps # Use FTPS (FTP over SSL/TLS) for secure file transfer
          # Alternative protocols if FTPS doesn't work: "ftp" or "ftps-legacy"
          port: ${{ secrets.FTP_PORT || 21 }} # FTPS default port is 21 (or 990 for explicit FTPS)
          local-dir: ./frontend/dist/spa/
          server-dir: /public_html/app/
          exclude: |
            **/.git*
            **/.git*/**
            **/.DS_Store
            **/Thumbs.db
      
      # Step 6: Deployment summary
      - name: Deployment summary
        run: |
          echo "‚úÖ Frontend deployment completed successfully!"
          echo ""
          echo "üåê Frontend files deployed to: /public_html/sms/"
          echo "üîó API URL configured: ${{ secrets.FRONTEND_API_URL || 'https://sms.kdgsolution.com/api' }}"
          echo ""
          echo "‚ö†Ô∏è  Important post-deployment steps:"
          echo "   1. Verify the API URL is correct in the deployed files"
          echo "   2. Ensure your domain points to /public_html/sms/"
          echo "   3. Check that .htaccess file exists for Vue Router history mode"
          echo "   4. Test the application in a browser"

