name: Deploy Frontend to Shared Hosting

# This workflow deploys the Quasar/Vue frontend to shared hosting via FTPS
# It builds the frontend with the production API URL and deploys to /public_html
# No SSH access required - uses FTPS (FTP over SSL/TLS) for secure transfer

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend.yml'
  workflow_dispatch: # Allow manual trigger from GitHub Actions UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      # Step 3: Install dependencies
      - name: Install npm dependencies
        run: |
          cd frontend
          npm ci
      
      # Step 4: Update API URL in .quasar.env.json for production build
      - name: Configure production API URL
        run: |
          cd frontend
          # Update .quasar.env.json with production API URL from secret or use default
          API_URL="${{ secrets.FRONTEND_API_URL || 'https://sms.kdgsolution.com/api' }}"
          cat > .quasar.env.json << EOF
          {
            "dev": {
              "API_URL": "http://localhost:8000/api"
            },
            "production": {
              "API_URL": "${API_URL}"
            }
          }
          EOF
          echo "âœ… API URL configured: ${API_URL}"
      
      # Step 5: Build frontend with production configuration
      - name: Build frontend
        run: |
          cd frontend
          npm run build
        env:
          NODE_ENV: production
          QUASAR_MODE: spa
          API_URL: ${{ secrets.FRONTEND_API_URL || 'https://sms.kdgsolution.com/api' }}
      
      # Step 6: Deploy built files to /public_html
      # The Quasar build outputs to dist/spa/ directory
      - name: Deploy frontend to /public_html
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps # Use FTPS (FTP over SSL/TLS) for secure file transfer
          # Alternative protocols if FTPS doesn't work: "ftp" or "ftps-legacy"
          port: ${{ secrets.FTP_PORT || 21 }} # FTPS default port is 21 (or 990 for explicit FTPS)
          local-dir: ./frontend/dist/spa/
          server-dir: /public_html/app/
          exclude: |
            **/.git*
            **/.git*/**
            **/.DS_Store
            **/Thumbs.db
      
      # Step 6: Deployment summary
      - name: Deployment summary
        run: |
          echo "âœ… Frontend deployment completed successfully!"
          echo ""
          echo "ðŸŒ Frontend files deployed to: /public_html/sms/"
          echo "ðŸ”— API URL configured: ${{ secrets.FRONTEND_API_URL || 'https://api.yourschool.com/api' }}"
          echo ""
          echo "âš ï¸  Important post-deployment steps:"
          echo "   1. Verify the API URL is correct in the deployed files"
          echo "   2. Ensure your domain points to /public_html/sms/"
          echo "   3. Check that .htaccess file exists for Vue Router history mode"
          echo "   4. Test the application in a browser"

